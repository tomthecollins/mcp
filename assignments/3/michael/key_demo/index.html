<!DOCTYPE html>

<html>
<head>
    <title>Page Title</title>
    <script type="text/javascript" src="./Tone.min_r11.js"></script>
</head>

<body>
    <ol>
        <li>
            <p>
                Q. What is a key?
            </p>
            <p>
                A.
            </p>
        </li>
        <li>
            <p>
                Q. Why is 'a' next to 'C' and not 'c' next to 'C'?
            </p>
            <p>
                A.
            </p>
        </li>
    </ol>
    
    <div>
        <input type="button" onclick="Tone.Transport.start();" value="Start"></input>
        <input type="button" onclick="Tone.Transport.stop();" value="Stop"></input>
    </div>
    
    <dvi>
        <input type="button" onclick="changeKey('C');" value="C"></input>
        <input type="button" onclick="changeKey('E');" value="E"></input>
        <input type="button" onclick="changeKey('G');" value="G"></input>
    </dvi>
    
    <script>
        normalize = function(arr){
            var tot = arr.reduce(function(a, b){
                return a + b;
            });
            console.log('tot:', tot);
            var obj = {};
            arr.map(function(a, idx){
                obj[pcs[idx]] = a/tot;
            });
            return obj;
        }
        
        // Below is from maerics on https://stackoverflow.com/questions/8435183/generate-a-weighted-random-number
        function weightedRand2(spec) {
          var i, sum=0, r=Math.random();
          for (i in spec) {
            sum += spec[i];
            if (r <= sum) return i;
          }
        }
        
        // From maia-util.
        cyclically_permute_array_by = function(arr, m){
            // Tom Collins 6/11/2015.
            // In
            // arr Array mandatory
            // m Non-negative integer mandatory
            // Out Array
            // This function moves the ith element of an array (counting from zero) to
            // the zeroth element in the output array, where i is the second argument.
            // The (i - 1)th element is moved to the last element in the output array,
            // the (i - 2)th element is moved to the penultimate element in the output
            // array, etc.
          
            m = m % arr.length;
            var arr2 = copy_array_object(arr);
            var arr3 = arr2.slice(0, m);
            var arr4 = arr2.slice(m).concat(arr3);
            return arr4;
        }
        
        function copy_array_object(arr){
            // Tom Collins 21/2/2015.
            // In
            // arr Array mandatory
            // Out Array
            // This function returns an independent copy of an array object.
          
            var arr2 = JSON.parse(JSON.stringify(arr));
            return arr2;
        }
        
    </script>
   
    
    <script type="text/javascript">
        // Parameters.
        var generationFrequency = 3;
        var currentKey = "C";
        // Pitch-class probabilities.
        var weights = {};
        var ptp_orig = [
            6.35, // Prob of getting C.
            2.23, // Prob of getting C#.
            3.48, // Prob of getting D.
            2.33, // ...
            4.38,
            4.09,
            2.52,
            5.19,
            2.39,
            3.66,
            2.29,
            2.28, // Prob of getting B.
        ];
        var ptp = [
            6.35, // Prob of getting C.
            0, // Prob of getting C#. Put non-key notes to zero.
            3.48, // Prob of getting D.
            0, // ...
            4.38,
            4.09,
            0,
            5.19,
            0,
            3.66,
            ,
            2.28, // Prob of getting B.
        ];
        var pcs = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        
        changeKey = function(str){
            var idx = pcs.indexOf(str);
            console.log('idx:', idx);
            weights = copy_array_object(ptp);
            weights = cyclically_permute_array_by(weights, -idx);
            console.log('permuted weights:', weights);
            weights = normalize(weights);
            console.log('weights:', weights);
            
        }
        
        // Defining an instrument.
        var piano = new Tone.Sampler({
            "C4": "./acoustic_grand_piano/060_keyboard_acoustic_000-100.wav",
            "E4": "./acoustic_grand_piano/064_keyboard_acoustic_000-100.wav"
        }, function(){
            console.log('Piano loaded!');
        });
        piano.toMaster();
        piano.volume.value = -10;
        
        // Start generating some sounds.
        Tone.Transport.scheduleRepeat(function(time){
            // Make some sounds.
            var nosNotes = Math.floor(3*Math.random());
            var notesHolder = [];
            for (i = 0; i < nosNotes; i++){
                notesHolder.push(i);
            }
            console.log('notesHolder:', notesHolder);
            notesHolder.map(function(n){
                Tone.Transport.schedule(function(time2){
                    var pitch_class = weightedRand2(weights);
                    console.log('pitch_class', pitch_class);
                    var octave_no = 4;
                    var pitch = pitch_class + octave_no.toString();
                    console.log('pitch:', pitch);
                    piano.triggerAttackRelease(pitch, 2, time2 + 0.05, 0.9);
                }, time);
            });
        }, 1/generationFrequency);
        
        // Initialize key to C.
        changeKey("C");
        
        
    </script>



</body>
</html>
