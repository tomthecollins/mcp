<!DOCTYPE html>

<html>
<head>
	<meta charset="utf-8"/>
  <title>Piano keyboard</title>
		<script type="text/javascript" src="./../../../lib/jquery.min.js"></script>
		<script type="text/javascript" src="./../../../lib/Tone.min_r11.js"></script>
		<script type="text/javascript" src="./supporting/keykey.js"></script>
		<script type="text/javascript" src="./supporting/nexusUI.js"></script>
		<style type="text/css" id="hello">
   canvas {
    width: 520px;
    height: 400px;
    /*background-color: black;*/
    /*border-bottom-left-radius: 5px;*/
    /*border-bottom-right-radius: 5px;*/
   }
  </style>
</head>
<body>
	<div id="Content">
		<div>
			<p>Hi!</p>
		</div>
		<div id="valaro"></div>
		<div>
			<canvas nx="keyboard" id="keyboard1"></canvas>
		</div>
	</div>
	<script type="text/javascript">
		
		
		
		// var canvas;
		// var context;
		// var canvas = document.getElementById('valaro');
		var canvas = $("<canvas>").appendTo("#valaro");
		var context = canvas.get(0).getContext("2d");
		context.canvas.width = canvas.width();
		context.canvas.height = canvas.height();
		console.log('context.canvas.width:', context.canvas.width);
		// Add the graphic to it.
		var bgImg = new Image(); 
		bgImg.src = './valaro.jpg';
		// bgImg.src = 'http://i.imgur.com/yf6d9SX.jpg';
		console.log('bgImg.width:', bgImg.width)
		bgImg.onload = function(){
			context.drawImage(bgImg, 0, 0, bgImg.width*1, bgImg.height*1);
		}
		
		
		
		
		
		// Started by making a matrix, which might be handy for displaying stuff...
		var ncol = 36;
		var nrow = 8;
		var lastXSec = 4;
		nx.onload = function(){
			nx.colorize("#f5871f");
			
			//matrix1.col = ncol;
			//matrix1.row = nrow;
			//matrix1.init();
			//matrix1.resize($("#Content").width(), 200);
			//matrix1.draw();
			
			// Here's the piano keyboard.
			keyboard1.octaves = 3;
			keyboard1.init();
			keyboard1.resize($("#Content").width(), 200);
		}
		
		// This makes it so the matrix and keyboard resize automatically when the
		// screen is resized.
		$(function(){
			$(window).on("resize", function(){
				// matrix1.resize($("#Content").width(), 200);
				// matrix1.draw();
				keyboard1.resize($("#Content").width());
			});
		});
		
		Tone.Transport.scheduleRepeat(function(time){
			
			// Evaluate some properties of what the user has played in the last x sec.
			
			// console.log('Tone.Transport.seconds:', Tone.Transport.seconds);
			// var timeWindowClose = Tone.Transport.seconds;
			var timeWindowOpen = Tone.Transport.seconds - lastXSec;
			var relevantNoteOns = noteOns.filter(function(n){
				return n[0] >= timeWindowOpen;
			})
			console.log('relevantNoteOns:', relevantNoteOns);
			
			var numberNotesPlayed = relevantNoteOns.length;
			var density;
			if (numberNotesPlayed >= 15){
				density = 1;
			}
			else if (numberNotesPlayed <= 5){
				density = 0;
			}
			else {
				density = (numberNotesPlayed - 5)/10;
			}
			
			var minorCount = 0;
			var minor;
			relevantNoteOns.map(function(n){
				var pitch_class = n[1].slice(0, n[1].length - 1);
				if (["D#", "A#"].indexOf(pitch_class) >= 0){
					minorCount++;
				}
			});
			console.log('minorCount:', minorCount);
			if (minorCount >= 3){
				minor = 1;
			}
			else {
				minor = minorCount/3;
			}
			
			console.log('density:', density);
			context.canvas.width = canvas.width();
			context.canvas.height = canvas.height();
			context.drawImage(bgImg, 0, 0, bgImg.width*1, bgImg.height*1);
			context.fillRect(470*(1 - minor), 350*(1 - density), 10, 10);
		}, 1);
		
		Tone.Transport.start();
		
	</script>
</body>
</html>
